"use strict";var fs=null,http=null,https=null,url=null;module.exports={classes:{},objects:{},constants:{__OBJ_OPEN:"{",__OBJ_CLOSE:"}",__OBJ_DELIM:":",__ARR_OPEN:"[",__ARR_CLOSE:"]",__STR_DELIM:'"',__ELEM_DELIM:",",__STR_ESCAPE:"\\",__CHAR_NEWLINE:"\n",__CHAR_SPACE:" ",__CHAR_TAB:"	",__TYPE_OBJECT:0,__TYPE_ARRAY:1,__TYPE_STRING:2,__TYPE_NUMBER:4,__TYPE_BOOLEAN:5,__TYPE_NULL:6,__TYPE_HEX:7}};var __c=module.exports.constants;module.exports.classes.Stack=function(){this.stack=[],this.peek=function(){return 0==this.length()?null:this.stack[this.stack.length-1]},this.push=function(element){this.stack.push(element)},this.pop=function(){return 0==this.length()?null:this.stack.pop()},this.length=function(){return this.stack.length},this.empty=function(){return 0==this.length()},this.clear=function(){this.stack=[]},this.toString=function(){return this.stack.join(" -> ")}},module.exports.classes.HashMap=function(){this.size=0,this.table={},this.set=function(key,value){return this.contains(key)||this.size++,this.table[key]=value,!0},this.remove=function(key){return this.contains(key)?(delete this.table[key],this.size--,!0):!1},this.contains=function(key){return this.table.hasOwnProperty(key)},this.get=function(key){return this.contains(key)?this.table[key]:null},this.length=function(){return this.size}},module.exports.classes.ObservableEvent=function(name,body){this.name=name,this.body=body,this.getName=function(){return this.name},this.getBody=function(){return this.body}},module.exports.classes.Observer=function(callback){this.callback=callback,this.notify=function(event){this.callback(event)}},module.exports.classes.Observable=function(){this.listeners={},this.registerObserver=function(name,observer){this.listeners.hasOwnProperty(name)||(this.listeners[name]=[]),this.listeners[name].push(observer)},this.unregisterObserver=function(name,observer){if(!this.listeners.hasOwnProperty(name))return!1;var listeners=[];for(var key in this.listeners)this.listeners.hasOwnProperty(key)&&this.listeners[key].forEach(function(listener){observer!==listener&&listeners.push(listener)});return this.listeners[name]=listeners,!0},this.notifyObservers=function(event){return this.listeners.hasOwnProperty(event.getName())?(this.listeners[event.getName()].forEach(function(listener){listener.notify(event)}),!0):!1},this.on=function(name,callback){if(!callback)throw Error("A callback function that accepts one parameter is required");var observer=new module.exports.classes.Observer(callback);return this.registerObserver(name,observer)}},module.exports.classes.Stream=function(){module.exports.classes.Observable.call(this),this.buffer=[],this.length=function(){return this.buffer.length},this.toString=function(callback){if(!callback)return this.buffer.join("");if(0==this.buffer.length){var error=Error("stream is empty");if(!callback)throw error;return callback(error,null),void 0}return callback?(callback(null,this.buffer.join("")),void 0):this.buffer.join("")},this.writeChar=function(data){this.buffer.push(data),this.notifyObservers(new module.exports.classes.ObservableEvent("write",data))},this.writeString=function(string){var data=string.split("");this.buffer=this.buffer.concat(data),this.notifyObservers(new module.exports.classes.ObservableEvent("write",data))},this.writeArray=function(data){this.buffer=this.buffer.concat(data),this.notifyObservers(new module.exports.classes.ObservableEvent("write",data))},this.read=function(callback){if(!callback)return this.buffer.shift();if(0==this.buffer.length){var error=Error("stream is empty");if(!callback)throw error;return callback(error,null),!1}var data=this.buffer.shift();return callback?(callback(null,data),!0):data},this.flush=function(callback){var data=null;if(0==this.buffer.length){var error=Error("stream is empty");if(!callback)throw error;return callback(error,null),void 0}return data=this.buffer.splice(0),callback?(callback(null,data),this.notifyObservers(new module.exports.classes.ObservableEvent("flush",data)),void 0):data}},module.exports.classes.Chunk=function(type){this.buffer=[],this.type=type,this.append=function(token){this.buffer.push(token)},this.getValue=function(){switch(this.type){case __c.__TYPE_BOOLEAN:return this.getBooleanValue();case __c.__TYPE_NUMBER:return this.getNumericValue();case __c.__TYPE_NULL:return this.getNullValue()}return this.buffer.join("")},this.getNullValue=function(){var value=this.buffer.join("").toLowerCase();if("null"!==value)throw Error("invalid token: "+value);return null},this.getBooleanValue=function(){var value=this.buffer.join("").toLowerCase();switch(value){case"true":return!0;case"false":return!1}throw Error("invalid boolean value: "+value)},this.getNumericValue=function(){var value=this.buffer.join("");if(value.match(/[^\deE\+\-\.]/g))throw Error("invalid numeric value: "+value);return value.match(/[eE\.]/)?parseFloat(value):parseInt(value)},this.getType=function(){return this.type},this.toString=function(){return this.buffer.join("")}},module.exports.classes.TokenHandler=function(parser){module.exports.classes.Observable.call(this),this.parser=parser,this.chunks=new module.exports.classes.Stack,this.keys=new module.exports.classes.Stack,this.objKeys=new module.exports.classes.Stack,this.ignore={},this.ignore[__c.__CHAR_NEWLINE]=!0,this.ignore[__c.__CHAR_SPACE]=!0,this.ignore[__c.__CHAR_TAB]=!0,this.control={},this.control.b="0008",this.control.t="0009",this.control.n="000A",this.control.r="000D",this.control.f="000C";var scope=this;this.state={escaped:!1,string:!1,unicode:!1,unibuff:[]},this.handlers={},this.registerHandler=function(token,callback){callback=callback.bind(scope),this.handlers[token]=callback},this.determineType=function(token){if(!token)return!1;if(token.match(/[0-9\.\-]/))return __c.__TYPE_NUMBER;if(token.match(/[tTfF]/))return __c.__TYPE_BOOLEAN;if(token.match(/[nN]/))return __c.__TYPE_NULL;throw Error("unable to determine type for token "+token)},this.determineClass=function(o){return o?"[object Array]"===Object.prototype.toString.call(o)?__c.__TYPE_ARRAY:"[object Object]"===Object.prototype.toString.call(o)?__c.__TYPE_OBJECT:__c.__TYPE_STRING:!1},this.addNewElement=function(o,scalar){var element=this.parser.elements.peek(),type=this.determineClass(element);switch(type){case __c.__TYPE_ARRAY:element.push(o);break;case __c.__TYPE_OBJECT:if(this.keys.empty())throw Error("unable to add value to object with key");var key=this.keys.pop();element[key]=o,this.notifyObservers(new module.exports.classes.ObservableEvent("found",{key:key,value:o})),this.objKeys.push(key)}scalar||this.parser.elements.push(o)},this.addNewChunk=function(){if(this.chunks.empty())return!1;var chunk=this.chunks.peek(),element=this.parser.elements.peek(),type=this.determineClass(element);switch(type){case __c.__TYPE_ARRAY:element.push(chunk.getValue());break;case __c.__TYPE_OBJECT:if(this.keys.empty()){var key=chunk.getValue();this.keys.push(key),this.notifyObservers(new module.exports.classes.ObservableEvent("found",{key:key}))}else{var key=this.keys.pop(),value=chunk.getValue();element[key]=chunk.getValue(),this.notifyObservers(new module.exports.classes.ObservableEvent("parsed",{key:key,value:value}))}break;default:throw Error("badly formed JSON stream")}return this.state.string=!1,this.state.escaped=!1,this.chunks.pop(),!0},this.registerHandler("__default__",function(token){if(this.state.string){if(this.state.escaped){if(this.state.escaped=!this.state.escaped,this.control.hasOwnProperty(token))return this.chunks.peek().append(String.fromCharCode(parseInt(this.control[token],16)));if("u"===token)return this.state.unicode=!0,void 0}if(this.state.unicode){if(this.state.unibuff.push(token),token.match("/[^0-9a-fA-F]/"))throw Error("invalid unicode sequence "+this.state.unibuff.join(""));if(4==this.state.unibuff.length){var unicode=this.state.unibuff.join("");if("0022"===unicode)throw Error('invalid unicode sequence "');this.chunks.peek().append(String.fromCharCode(parseInt(unicode,16))),this.state.unicode=!1,this.state.unibuff=[]}return}if(this.chunks.peek().getType()!==__c.__TYPE_STRING&&this.ignore.hasOwnProperty(token))return;return this.chunks.peek().append(token)}if(this.ignore.hasOwnProperty(token))return!1;var chunk=new module.exports.classes.Chunk(this.determineType(token));chunk.append(token),chunk.open=!0,this.state.string=!0,this.state.escaped=!1,this.chunks.push(chunk)}),this.registerHandler(__c.__STR_ESCAPE,function(token){if(!this.state.string)throw Error("unable to escape value outside string");this.state.escaped&&this.chunks.peek().append(token),this.state.escaped=!this.state.escaped}),this.registerHandler(__c.__OBJ_OPEN,function(token){return this.state.string?this.chunks.peek().append(token):(this.addNewElement({}),void 0)}),this.registerHandler(__c.__OBJ_CLOSE,function(token){if(this.state.string&&this.chunks.peek().getType()==__c.__TYPE_STRING)return this.chunks.peek().append(token);this.addNewChunk();var key=this.objKeys.pop(),element=this.parser.elements.peek(),type=this.determineClass(element);if(type!==__c.__TYPE_OBJECT)throw Error("badly formed object");element=this.parser.elements.pop(),this.notifyObservers(new module.exports.classes.ObservableEvent("parsed",{key:key,value:element}))}),this.registerHandler(__c.__ARR_OPEN,function(token){return this.state.string?this.chunks.peek().append(token):(this.addNewElement([]),void 0)}),this.registerHandler(__c.__ARR_CLOSE,function(token){if(this.state.string&&this.chunks.peek().getType()==__c.__TYPE_STRING)return this.chunks.peek().append(token);this.addNewChunk();var element=this.parser.elements.peek(),type=this.determineClass(element);if(type!==__c.__TYPE_ARRAY)throw Error("badly formed array");if(element=this.parser.elements.pop(),!this.objKeys.empty()&&this.determineClass(this.parser.elements.peek())==__c.__TYPE_OBJECT){var key=this.objKeys.pop();this.notifyObservers(new module.exports.classes.ObservableEvent("parsed",{key:key,value:element}))}}),this.registerHandler(__c.__OBJ_DELIM,function(token){var chunk=this.chunks.peek();return this.state.string?chunk.append(token):(this.addNewChunk(),void 0)}),this.registerHandler(__c.__ELEM_DELIM,function(token){return this.state.string&&this.chunks.peek().getType()==__c.__TYPE_STRING?this.chunks.peek().append(token):this.addNewChunk()}),this.registerHandler(__c.__STR_DELIM,function(token){var chunk=null;return this.state.string?(chunk=this.chunks.peek(),this.state.escaped?chunk.append(token):(chunk.open=!1,this.state.string=!1,this.state.escaped=!1,void 0)):(chunk=new module.exports.classes.Chunk(__c.__TYPE_STRING),chunk.open=!0,this.state.string=!0,this.state.escaped=!1,this.chunks.push(chunk),void 0)}),this.handle=function(token){return this.handlers.hasOwnProperty(token)?this.handlers[token](token):this.handlers.__default__(token)}},module.exports.classes.StreamParser=function(){module.exports.classes.Observable.call(this);var __t=this;this.stream=new module.exports.classes.Stream,this.elements=new module.exports.classes.Stack,this.handler=new module.exports.classes.TokenHandler(this),this.handler.on("found",function(data){var body=data.getBody();body.key&&__t.notifyObservers(new module.exports.classes.ObservableEvent("found:"+body.key,body))}),this.handler.on("parsed",function(data){var body=data.getBody();body.key&&__t.notifyObservers(new module.exports.classes.ObservableEvent("parsed:"+body.key,body.value))}),this.handler.on("parsed",function(data){__t.notifyObservers(data)}),this.onFind=function(key,callback){this.on("found:"+key,function(event){callback(null,event.getBody())})},this.onParse=function(key,callback){this.on("parsed:"+key,function(event){callback(null,event.getBody())})},this.onMatch=function(pattern,callback){this.on("parsed",function(event){var body=event.getBody();body.key&&body.key.match(pattern)&&callback(null,event.getBody())})},this.onError=function(callback){this.on("error",function(event){callback(event.getBody(),null)})},this.resetScope=function(){this.elements.clear(),this.elements.push([]),this.scope=this.elements.peek()},this.consume=function(source){this.stream.writeString(source)},this.parse=function(){try{for(;__t.stream.read(function(err,token){err||__t.handler.handle(token)}););}catch(e){__t.resetScope(),__t.notifyObservers(new module.exports.classes.ObservableEvent("error",e))}},this.getScope=function(){return this.scope},this.resetScope(),this.stream.on("write",this.parse)},module.exports.classes.Jaxon=function(){this.parser=new module.exports.classes.StreamParser;var scope=this;this.parse=function(path,options,callback){return options=options||{},path.match(/^file\:\/\//)?this.parseFileStream(path,options,callback):path.match(/^http\:\/\//)?this.parseHttpStream(path,options,callback):path.match(/^https\:\/\//)?this.parseHttpsStream(path,options,callback):callback(Error("unrecognised url scheme: "+path)),this.parser.getScope()},this.on=function(event,key,callback){switch(event){case"error":callback=key,this.parser.onError(callback);break;case"parse":this.parser.onParse(key,callback);break;case"match":this.parser.onMatch(key,callback);break;case"find":this.parser.onFind(key,callback);break;default:callback(Error("unrecognized event: "+event))}},this.parseFileStream=function(path,options,callback){fs||(fs=require("fs"));var p=path.replace(/^file\:\/\//,""),instream=fs.createReadStream(p,{flags:"r",encoding:"utf8",bufferSize:4100});instream.on("error",callback),instream.on("data",function(buffer){scope.parser.consume(buffer)})},this.parseHttpStream=function(path,options,callback){http||(http=require("http")),url||(url=require("url"));var opt=url.parse(path);options["user-agent"]&&(opt["user-agent"]=options["user-agent"]),options.accept&&(opt.accept=options.accept),http.get(opt,function(res){res.on("data",function(data){scope.parser.consume(""+data)})}).on("error",function(e){callback(e)})},this.parseHttpsStream=function(path,options,callback){https||(https=require("https")),url||(url=require("url"));var opt=url.parse(path);options["user-agent"]&&(opt["user-agent"]=options["user-agent"]),options.accept&&(opt.accept=options.accept),https.get(opt,function(res){res.on("data",function(data){scope.parser.consume(""+data)})}).on("error",function(e){callback(e)})}},module.exports.objects.parser=new module.exports.classes.Jaxon,module.exports.factoryStack=function(){return new module.exports.classes.Stack},module.exports.factoryHashMap=function(){return new module.exports.classes.HashMap},module.exports.factoryStream=function(){return new module.exports.classes.Stream},module.exports.factoryObservableEvent=function(name,body){return new module.exports.classes.ObservableEvent(name,body)},module.exports.factoryObservable=function(){return new module.exports.classes.Observable},module.exports.factoryObserver=function(callback){return new module.exports.classes.Observer(callback)},module.exports.factoryChunk=function(type){return new module.exports.classes.Chunk(type)},module.exports.factoryStreamParser=function(scope){return new module.exports.classes.StreamParser(scope)},module.exports.factoryTokenHandler=function(parser){return new module.exports.classes.TokenHandler(parser)},module.exports.factoryJaxon=function(){return new module.exports.classes.Jaxon};